{% extends "base.html" %}

{% block title %}Interactive Survey Map - SurveyPro{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
    <!-- Map Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-map mr-3 text-blue-600"></i>
                Interactive Survey Map
            </h1>
            <p class="text-gray-600 mt-2">Professional mapping interface with polygon drawing, multiple map layers, and real-time calculations</p>
        </div>
        
        <!-- Map View Controls -->
        <div class="mt-4 lg:mt-0">
            <div class="flex space-x-2">
                <button onclick="switchMapLayer('street')" id="streetBtn" class="map-layer-btn bg-blue-600 text-white">
                    <i class="fas fa-road mr-1"></i> Street
                </button>
                <button onclick="switchMapLayer('satellite')" id="satelliteBtn" class="map-layer-btn">
                    <i class="fas fa-satellite mr-1"></i> Satellite
                </button>
                <button onclick="switchMapLayer('terrain')" id="terrainBtn" class="map-layer-btn">
                    <i class="fas fa-mountain mr-1"></i> Terrain
                </button>
            </div>
        </div>
    </div>

    <!-- Main Map Interface -->
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
        <!-- Map Container -->
        <div class="xl:col-span-3">
            <div class="bg-white rounded-xl shadow-lg p-4 border border-gray-200">
                <div class="map-container">
                    {{ map_html|safe }}
                </div>
                
                <!-- Map Tools -->
                <div class="mt-4 flex flex-wrap gap-2">
                    <button onclick="toggleMeasurement()" class="tool-btn">
                        <i class="fas fa-ruler mr-2"></i>Measurement Tools
                    </button>
                    <button onclick="toggleCoordinateGrid()" class="tool-btn">
                        <i class="fas fa-th mr-2"></i>Coordinate Grid
                    </button>
                    <button onclick="centerMap()" class="tool-btn">
                        <i class="fas fa-crosshairs mr-2"></i>Center Map
                    </button>
                    <button onclick="exportMapView()" class="tool-btn">
                        <i class="fas fa-download mr-2"></i>Export View
                    </button>
                </div>
            </div>
        </div>
    
        <!-- Map Sidebar -->
        <div class="xl:col-span-1 space-y-6">
            <!-- Live Statistics -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-blue-600"></i>
                    Live Statistics
                </h3>
                <div class="space-y-4" id="mapStats">
                    <!-- Stats will be loaded here -->
                </div>
            </div>

            <!-- Reference Points -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-map-pin mr-2 text-blue-600"></i>
                        Reference Points
                    </h3>
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{{ points|length }}</span>
                </div>
                
                {% if points %}
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for point in points %}
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-gray-900">{{ point.name }}</h4>
                                <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">{{ point.point_type }}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">{{ point.description or 'No description' }}</p>
                            <div class="text-xs text-gray-500 space-y-1">
                                <div>Lat: {{ "%.6f"|format(point.latitude) }}</div>
                                <div>Lon: {{ "%.6f"|format(point.longitude) }}</div>
                                {% if point.elevation %}
                                <div>Elevation: {{ point.elevation }} m</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 text-sm">No reference points yet. Use drawing tools to add some!</p>
                {% endif %}
                
                <button onclick="showAddPointModal()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>Add Reference Point
                </button>
            </div>

            <!-- Survey Polygons -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-draw-polygon mr-2 text-green-600"></i>
                        Survey Polygons
                    </h3>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{{ polygons|length }}</span>
                </div>
                
                {% if polygons %}
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for polygon in polygons %}
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-gray-900">{{ polygon.name }}</h4>
                                <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">{{ polygon.polygon_type }}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">{{ polygon.description or 'No description' }}</p>
                            <div class="text-xs text-gray-500 space-y-1">
                                <div>Area: {{ "%.2f"|format(polygon.area_sqm) }} mÂ²</div>
                                <div>Perimeter: {{ "%.2f"|format(polygon.perimeter_m) }} m</div>
                                <div>Vertices: {{ polygon.coordinates|length }}</div>
                            </div>
                            <button onclick="deletePolygon({{ polygon.id }})" class="mt-2 text-red-600 hover:text-red-800 text-xs font-medium">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 text-sm">No polygons yet. Use the drawing tools on the map!</p>
                {% endif %}
                
                <button onclick="showAddPolygonModal()" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>Add Polygon Manually
                </button>
            </div>
            
            <!-- Import/Export Tools -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-exchange-alt mr-2 text-purple-600"></i>
                    Import/Export
                </h3>
                
                <div class="space-y-3">
                    <div class="grid grid-cols-1 gap-2">
                        <a href="/api/export/csv" class="export-btn bg-green-600 hover:bg-green-700">
                            <i class="fas fa-file-csv mr-2"></i>CSV Format
                        </a>
                        <a href="/api/export/geojson" class="export-btn bg-blue-600 hover:bg-blue-700">
                            <i class="fas fa-file-code mr-2"></i>GeoJSON Format
                        </a>
                        <a href="/api/export/kml" class="export-btn bg-yellow-600 hover:bg-yellow-700">
                            <i class="fas fa-globe mr-2"></i>KML Format
                        </a>
                    </div>
                    
                    <button onclick="showImportModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                        <i class="fas fa-upload mr-2"></i>Import Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Point Modal -->
<div class="modal fade" id="mapAddPointModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Reference Point</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="mapAddPointForm">
                    <div class="mb-3">
                        <label for="mapPointName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="mapPointName" required>
                    </div>
                    <div class="mb-3">
                        <label for="mapPointDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="mapPointDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="mapPointLatitude" class="form-label">Latitude</label>
                            <input type="number" step="any" class="form-control" id="mapPointLatitude" required>
                        </div>
                        <div class="col-md-6">
                            <label for="mapPointLongitude" class="form-label">Longitude</label>
                            <input type="number" step="any" class="form-control" id="mapPointLongitude" required>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="mapPointElevation" class="form-label">Elevation (m)</label>
                        <input type="number" step="any" class="form-control" id="mapPointElevation">
                    </div>
                    <div class="mb-3">
                        <label for="mapPointType" class="form-label">Point Type</label>
                        <select class="form-control" id="mapPointType">
                            <option value="waypoint">Waypoint</option>
                            <option value="benchmark">Benchmark</option>
                            <option value="survey_point">Survey Point</option>
                            <option value="control_point">Control Point</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addMapPoint()">Add Point</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Polygon Modal -->
<div class="modal fade" id="addPolygonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Survey Polygon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPolygonForm">
                    <div class="mb-3">
                        <label for="polygonName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="polygonName" required>
                    </div>
                    <div class="mb-3">
                        <label for="polygonDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="polygonDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="polygonType" class="form-label">Polygon Type</label>
                        <select class="form-control" id="polygonType">
                            <option value="survey_area">Survey Area</option>
                            <option value="property_boundary">Property Boundary</option>
                            <option value="restricted_zone">Restricted Zone</option>
                            <option value="construction_zone">Construction Zone</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Coordinates (Latitude, Longitude pairs)</label>
                        <div id="coordinateInputs">
                            <div class="input-group mb-2">
                                <input type="number" step="any" class="form-control" placeholder="Latitude" name="lat">
                                <input type="number" step="any" class="form-control" placeholder="Longitude" name="lon">
                                <button type="button" class="btn btn-outline-danger" onclick="removeCoordinate(this)">Remove</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCoordinateInput()">Add Coordinate</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addPolygon()">Add Polygon</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Survey Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFormat" class="form-label">Import Format</label>
                    <select class="form-control" id="importFormat" onchange="updateImportUI()">
                        <option value="geojson">GeoJSON</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="importFile" class="form-label">Select file</label>
                    <input type="file" class="form-control" id="importFile" accept=".geojson,.json,.csv">
                </div>
                <div class="mb-3" id="jsonTextArea">
                    <label for="importText" class="form-label">Or paste GeoJSON data</label>
                    <textarea class="form-control" id="importText" rows="10" 
                        placeholder='{"type": "FeatureCollection", "features": []}'></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importData()">Import</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.map-layer-btn {
    @apply px-4 py-2 rounded-lg font-medium text-sm transition-colors duration-200 border border-gray-300 text-gray-700 hover:bg-gray-50;
}
.map-layer-btn.active {
    @apply bg-blue-600 text-white border-blue-600;
}
.tool-btn {
    @apply px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors duration-200;
}
.export-btn {
    @apply flex items-center justify-center text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let coordinateGridVisible = false;
let currentMapLayer = 'street';

// Page initialization
document.addEventListener('DOMContentLoaded', function() {
    loadMapStatistics();
    initializeMapControls();
});

// Map layer switching
function switchMapLayer(layer) {
    currentMapLayer = layer;
    
    // Update button states
    document.querySelectorAll('.map-layer-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-600', 'text-white', 'border-blue-600');
        btn.classList.add('border-gray-300', 'text-gray-700');
    });
    
    const activeBtn = document.getElementById(layer + 'Btn');
    if (activeBtn) {
        activeBtn.classList.add('active', 'bg-blue-600', 'text-white', 'border-blue-600');
        activeBtn.classList.remove('border-gray-300', 'text-gray-700');
    }
    
    // This would typically interact with the Leaflet map instance
    // For Folium, the layer control is built-in
    console.log(`Switched to ${layer} view`);
}

// Map statistics
async function loadMapStatistics() {
    try {
        const [pointsResponse, polygonsResponse] = await Promise.all([
            fetch('/api/points'),
            fetch('/api/polygons')
        ]);
        
        const points = await pointsResponse.json();
        const polygons = await polygonsResponse.json();
        
        displayMapStatistics(points, polygons);
    } catch (error) {
        console.error('Error loading map statistics:', error);
    }
}

function displayMapStatistics(points, polygons) {
    const totalArea = polygons.reduce((sum, p) => sum + (p.area_sqm || 0), 0);
    const totalPerimeter = polygons.reduce((sum, p) => sum + (p.perimeter_m || 0), 0);
    const totalVertices = polygons.reduce((sum, p) => sum + (p.coordinates ? p.coordinates.length : 0), 0);
    
    const statsContainer = document.getElementById('mapStats');
    if (statsContainer) {
        statsContainer.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-blue-900">Total Points</span>
                    <span class="text-lg font-bold text-blue-700">${points.length}</span>
                </div>
            </div>
            
            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-green-900">Survey Areas</span>
                    <span class="text-lg font-bold text-green-700">${polygons.length}</span>
                </div>
            </div>
            
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                <div class="text-sm font-medium text-purple-900 mb-1">Total Coverage</div>
                <div class="text-lg font-bold text-purple-700">${formatArea(totalArea)}</div>
                <div class="text-xs text-purple-600">${totalPerimeter.toFixed(0)}m perimeter</div>
            </div>
            
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-indigo-900">Vertices</span>
                    <span class="text-lg font-bold text-indigo-700">${totalVertices}</span>
                </div>
            </div>
        `;
    }
}

function formatArea(area) {
    if (area >= 10000) {
        return (area / 10000).toFixed(2) + ' ha';
    } else {
        return area.toFixed(0) + ' mÂ²';
    }
}

// Map controls
function initializeMapControls() {
    // Set initial button state
    switchMapLayer('street');
}

function centerMap() {
    // This would center the map on all points
    alert('Map centered on survey area');
}

function exportMapView() {
    // This would export the current map view
    window.open('/api/export/geojson', '_blank');
}

function showAddPointModal() {
    document.getElementById('mapAddPointModal').classList.remove('hidden');
}

function addMapPoint() {
    const formData = {
        name: document.getElementById('mapPointName').value,
        description: document.getElementById('mapPointDescription').value,
        latitude: document.getElementById('mapPointLatitude').value,
        longitude: document.getElementById('mapPointLongitude').value,
        elevation: document.getElementById('mapPointElevation').value,
        point_type: document.getElementById('mapPointType').value
    };

    fetch('/api/points', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        alert('Point added successfully!');
        bootstrap.Modal.getInstance(document.getElementById('mapAddPointModal')).hide();
        document.getElementById('mapAddPointForm').reset();
        location.reload();
    })
    .catch(error => {
        alert('Error adding point: ' + error);
    });
}

function showAddPolygonModal() {
    new bootstrap.Modal(document.getElementById('addPolygonModal')).show();
    // Add initial coordinate inputs
    addCoordinateInput();
    addCoordinateInput();
}

function addCoordinateInput() {
    const container = document.getElementById('coordinateInputs');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="number" step="any" class="form-control" placeholder="Latitude" name="lat">
        <input type="number" step="any" class="form-control" placeholder="Longitude" name="lon">
        <button type="button" class="btn btn-outline-danger" onclick="removeCoordinate(this)">Remove</button>
    `;
    container.appendChild(div);
}

function removeCoordinate(button) {
    const container = document.getElementById('coordinateInputs');
    if (container.children.length > 3) { // Keep at least 3 coordinates
        button.parentElement.remove();
    } else {
        alert('A polygon must have at least 3 coordinates');
    }
}

function addPolygon() {
    const name = document.getElementById('polygonName').value;
    const description = document.getElementById('polygonDescription').value;
    const type = document.getElementById('polygonType').value;
    
    const coordinateInputs = document.querySelectorAll('#coordinateInputs .input-group');
    const coordinates = [];
    
    coordinateInputs.forEach(group => {
        const lat = parseFloat(group.querySelector('input[name="lat"]').value);
        const lon = parseFloat(group.querySelector('input[name="lon"]').value);
        if (!isNaN(lat) && !isNaN(lon)) {
            coordinates.push([lat, lon]);
        }
    });
    
    if (coordinates.length < 3) {
        alert('A polygon must have at least 3 valid coordinates');
        return;
    }
    
    const formData = {
        name: name,
        description: description,
        coordinates: coordinates,
        polygon_type: type
    };

    fetch('/api/polygons', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        alert('Polygon added successfully!');
        bootstrap.Modal.getInstance(document.getElementById('addPolygonModal')).hide();
        document.getElementById('addPolygonForm').reset();
        document.getElementById('coordinateInputs').innerHTML = '';
        location.reload();
    })
    .catch(error => {
        alert('Error adding polygon: ' + error);
    });
}

function deletePolygon(polygonId) {
    if (confirm('Are you sure you want to delete this polygon?')) {
        fetch(`/api/polygons/${polygonId}`, {
            method: 'DELETE'
        })
        .then(() => {
            location.reload();
        });
    }
}

function showImportModal() {
    new bootstrap.Modal(document.getElementById('importModal')).show();
}

function updateImportUI() {
    const format = document.getElementById('importFormat').value;
    const fileInput = document.getElementById('importFile');
    const textArea = document.getElementById('jsonTextArea');
    
    if (format === 'csv') {
        fileInput.accept = '.csv';
        textArea.style.display = 'none';
    } else {
        fileInput.accept = '.geojson,.json';
        textArea.style.display = 'block';
    }
}

function importData() {
    const format = document.getElementById('importFormat').value;
    const fileInput = document.getElementById('importFile');
    const textInput = document.getElementById('importText').value;
    
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        fetch(`/api/import/${format}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully imported ${data.imported_points} points and ${data.imported_polygons} polygons!`);
                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                location.reload();
            } else {
                alert('Import failed: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error importing data: ' + error);
        });
    } else if (textInput && format === 'geojson') {
        // Handle text input for GeoJSON
        const blob = new Blob([textInput], { type: 'application/json' });
        const file = new File([blob], 'import.geojson', { type: 'application/json' });
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/api/import/geojson', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully imported ${data.imported_points} points and ${data.imported_polygons} polygons!`);
                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                location.reload();
            } else {
                alert('Import failed: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error importing data: ' + error);
        });
    } else {
        alert('Please select a file or paste data (for GeoJSON)');
    }
}

function toggleCoordinateGrid() {
    coordinateGridVisible = !coordinateGridVisible;
    
    if (coordinateGridVisible) {
        // Add coordinate grid overlay (this would be implemented with Leaflet.js directly)
        alert('Coordinate grid enabled. GPS coordinates are displayed in point popups and UTM coordinates are calculated automatically.');
    } else {
        alert('Coordinate grid disabled.');
    }
}

function toggleMeasurement() {
    alert('Use the drawing tools on the left side of the map:\n' +
          'â¢ Polygon tool for drawing survey areas\n' + 
          'â¢ Line tool for measuring distances\n' +
          'â¢ Marker tool for adding points\n' +
          'â¢ Rectangle tool for quick rectangular areas');
}

// Enhanced map interaction
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced topography map loaded with:');
    console.log('â¢ Polygon drawing with automatic area/perimeter calculation');
    console.log('â¢ UTM coordinate conversion');
    console.log('â¢ CSV, GeoJSON, and KML import/export');
    console.log('â¢ Interactive measurement tools');
    
    // Add custom map event listeners if needed
    // This would integrate with the Folium draw plugin
});
</script>
{% endblock %}